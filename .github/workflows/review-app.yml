name: "Review app"

on:
  pull_request:
    types: [ opened, ready_for_review, review_requested, synchronize ]

concurrency:
  group: review-app
  cancel-in-progress: true

jobs:
  validation:
    uses: ./.github/workflows/fullcheck.yml
    secrets:
      API_KEY_OPEN_CAGE_DATA_GEOCODING: ${{ secrets.API_KEY_OPEN_CAGE_DATA_GEOCODING }}
      API_KEY_OPEN_CAGE_DATA_GEOSEARCH: ${{ secrets.API_KEY_OPEN_CAGE_DATA_GEOSEARCH }}
      SIRENE_BEARER_TOKEN: ${{ secrets.SIRENE_BEARER_TOKEN }}

  deploy-review-app:
    if: github.event.pull_request.draft == false && github.event.pull_request.state == 'open'
    uses: ./.github/workflows/review-app-deploy.yml
    needs: validation
    with:
      pull_request_id: ${{ github.event.number }}
      run_number: ${{ github.run_number }}
    secrets:
      SCALINGO_API_TOKEN: ${{ secrets.SCALINGO_API_TOKEN }}

  run-seeds:
    needs: deploy-review-app
    runs-on: ubuntu-latest
    environment: review-app
    steps:
      - name: Install scalingo CLI
        run: |
          wget -qO- https://cli-dl.scalingo.com/install.sh | bash
          echo "$HOME/bin" >> $GITHUB_PATH
      - name: Login to scalingo
        run: scalingo login --api-token ${{ secrets.SCALINGO_API_TOKEN }}
      - name: Run DB seed
        run: scalingo --app if-dev-back-pr${{ github.event.number }} run pnpm db:seed

  notify-pr:
    if: github.event.pull_request.draft == false && github.event.pull_request.state == 'open'
    runs-on: ubuntu-latest
    needs: deploy-review-app
    steps:
      - name: Find existing notification
        uses: peter-evans/find-comment@v2
        id: find-comment
        with:
          issue-number: ${{ github.event.number }}
          body-regex: Review app:\nhttps:\/\/if-dev-front-pr
      - name: Notify PR about the webapp url
        if: steps.find-comment.outputs.comment-id == ''
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: |
            Review app:
            https://if-dev-front-pr${{ github.event.number }}.osc-fr1.scalingo.io
